<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">>
<head>
    <title>Getting Started: Serving Web Content</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <script type="text/javascript" th:src="@{/js/crypto-js/aes.js}"></script>
    <script type="text/javascript" th:src="@{/js/crypto-js/pbkdf2.js}"></script>
    <script type="text/javascript" th:src="@{/js/jquery.cookie.min.js}"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>

</head>
<body>
Welcome to Password Management System!

<table>
    <tr><th></th></tr>
    <tr th:each="password: ${passwords}">
        <td th:text="${password.getDomain()}"> </td>
        <td th:text="${password.getDomainUsername()}"> </td>
        <td>
            <span th:id="'password-text-' + ${password.getId()}" class="password-text">

        </span>

            <script th:inline="javascript">
var encryptedPassword = /*[[${password.getEncryptedPassword()}]]*/ '';
var clearPasswordHash =  /*[[${password.getClearPasswordHash()}]]*/ '';
var atId = 'password-text-' + (/*[[${password.getId()}]]*/ '');
document.addEventListener("DOMContentLoaded", function(event) {
    decrypt(encryptedPassword, clearPasswordHash, atId);
});
                </script>

        </td>
    </tr>
</table>

<script type="text/javascript">
    function getEncryptKeyFromCookie() {
        return get_cookies_array()['EncryptKey'];
    }

    function get_cookies_array() {

        var cookies = { };

        if (document.cookie && document.cookie != '') {
            var split = document.cookie.split(';');
            for (var i = 0; i < split.length; i++) {
                var name_value = split[i].split("=");
                name_value[0] = name_value[0].replace(/^ /, '');
                cookies[decodeURIComponent(name_value[0])] = decodeURIComponent(name_value[1]);
            }
        }

        return cookies;

    }

    function decrypt(encryptedPassword, clearPasswordHash,  atId) {
            // - Code to execute when all DOM content is loaded.
            // - including fonts, images, etc.
        try {
            var encryptKey = getEncryptKeyFromCookie();
            var bytes = CryptoJS.AES.decrypt(encryptedPassword, encryptKey);
            var plaintext = bytes.toString(CryptoJS.enc.Utf8);

            if (checkIntegrity(plaintext, clearPasswordHash)) {
                document.getElementById(atId).innerText = plaintext;

            } else {
                document.getElementById(atId).innerText = "Cannot decrypt";

            }
        } catch (e){
            document.getElementById(atId).innerText = "Cannot decrypt";
        }
    }

    function checkIntegrity(clearPassword, clearPasswordHash) {

        return hash(clearPassword) == clearPasswordHash
    }

    function hash(message) {
        var iterations = 100;
        var userHash = CryptoJS.PBKDF2(message, "", { keySize: 256/32, iterations: iterations });

        return userHash.toString();
    }

</script>
</body>
</html>